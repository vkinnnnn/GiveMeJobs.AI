# CloudFront Distribution Configuration for GiveMeJobs Platform
# This configuration sets up a global CDN with optimized caching and compression

AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFront CDN configuration for GiveMeJobs platform static assets'

Parameters:
  Environment:
    Type: String
    Default: production
    AllowedValues: [development, staging, production]
    Description: Environment name
  
  DomainName:
    Type: String
    Default: assets.givemejobs.ai
    Description: Custom domain name for CDN
  
  S3BucketName:
    Type: String
    Default: givemejobs-static-assets
    Description: S3 bucket name for static assets
  
  CertificateArn:
    Type: String
    Description: ACM certificate ARN for HTTPS

Resources:
  # S3 Bucket for Static Assets
  StaticAssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${S3BucketName}-${Environment}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30
          - Id: DeleteIncompleteMultipartUploads
            Status: Enabled
            AbortIncompleteMultipartUpload:
              DaysAfterInitiation: 7
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, HEAD]
            AllowedOrigins: ['*']
            MaxAge: 3600
      NotificationConfiguration:
        CloudWatchConfigurations:
          - Event: s3:ObjectCreated:*
            CloudWatchConfiguration:
              LogGroupName: !Ref AssetUploadLogGroup

  # CloudWatch Log Group for Asset Uploads
  AssetUploadLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/s3/${S3BucketName}-${Environment}"
      RetentionInDays: 30

  # Origin Access Control for S3
  OriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "${S3BucketName}-${Environment}-oac"
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  # CloudFront Distribution
  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
          - !Ref DomainName
        
        # Origins
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt StaticAssetsBucket.RegionalDomainName
            S3OriginConfig:
              OriginAccessIdentity: ''
            OriginAccessControlId: !GetAtt OriginAccessControl.Id
        
        # Default Cache Behavior
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: !Ref OptimizedCachePolicy
          OriginRequestPolicyId: !Ref CORSOriginRequestPolicy
          ResponseHeadersPolicyId: !Ref SecurityHeadersPolicy
          Compress: true
          
        # Cache Behaviors for different asset types
        CacheBehaviors:
          # Images - Long cache with immutable
          - PathPattern: "*.jpg"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: !Ref ImmutableAssetsCachePolicy
            OriginRequestPolicyId: !Ref CORSOriginRequestPolicy
            ResponseHeadersPolicyId: !Ref SecurityHeadersPolicy
            Compress: true
          
          - PathPattern: "*.jpeg"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: !Ref ImmutableAssetsCachePolicy
            OriginRequestPolicyId: !Ref CORSOriginRequestPolicy
            ResponseHeadersPolicyId: !Ref SecurityHeadersPolicy
            Compress: true
          
          - PathPattern: "*.png"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: !Ref ImmutableAssetsCachePolicy
            OriginRequestPolicyId: !Ref CORSOriginRequestPolicy
            ResponseHeadersPolicyId: !Ref SecurityHeadersPolicy
            Compress: true
          
          - PathPattern: "*.webp"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: !Ref ImmutableAssetsCachePolicy
            OriginRequestPolicyId: !Ref CORSOriginRequestPolicy
            ResponseHeadersPolicyId: !Ref SecurityHeadersPolicy
            Compress: true
          
          # CSS/JS - Long cache with versioning
          - PathPattern: "*.css"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: !Ref VersionedAssetsCachePolicy
            OriginRequestPolicyId: !Ref CORSOriginRequestPolicy
            ResponseHeadersPolicyId: !Ref SecurityHeadersPolicy
            Compress: true
          
          - PathPattern: "*.js"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: !Ref VersionedAssetsCachePolicy
            OriginRequestPolicyId: !Ref CORSOriginRequestPolicy
            ResponseHeadersPolicyId: !Ref SecurityHeadersPolicy
            Compress: true
          
          # Fonts - Very long cache
          - PathPattern: "*.woff2"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: !Ref FontsCachePolicy
            OriginRequestPolicyId: !Ref CORSOriginRequestPolicy
            ResponseHeadersPolicyId: !Ref SecurityHeadersPolicy
            Compress: false  # Fonts are already compressed
          
          # API responses - Short cache
          - PathPattern: "/api/*"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: !Ref APICachePolicy
            OriginRequestPolicyId: !Ref CORSOriginRequestPolicy
            ResponseHeadersPolicyId: !Ref SecurityHeadersPolicy
            Compress: true
        
        # Global Settings
        Enabled: true
        HttpVersion: http2and3
        IPV6Enabled: true
        PriceClass: PriceClass_All
        
        # Custom Error Pages
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 404
            ResponsePagePath: /404.html
            ErrorCachingMinTTL: 300
          - ErrorCode: 404
            ResponseCode: 404
            ResponsePagePath: /404.html
            ErrorCachingMinTTL: 300
        
        # Logging
        Logging:
          Bucket: !GetAtt AccessLogsBucket.DomainName
          Prefix: cloudfront-logs/
          IncludeCookies: false
        
        # SSL Certificate
        ViewerCertificate:
          AcmCertificateArn: !Ref CertificateArn
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        
        # Web ACL (if needed)
        # WebACLId: !Ref WebACL

  # Cache Policies
  OptimizedCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Name: !Sub "OptimizedCachePolicy-${Environment}"
        DefaultTTL: 86400  # 1 day
        MaxTTL: 31536000   # 1 year
        MinTTL: 0
        ParametersInCacheKeyAndForwardedToOrigin:
          EnableAcceptEncodingGzip: true
          EnableAcceptEncodingBrotli: true
          QueryStringsConfig:
            QueryStringBehavior: none
          HeadersConfig:
            HeaderBehavior: whitelist
            Headers:
              - Accept
              - Accept-Encoding
              - Accept-Language
          CookiesConfig:
            CookieBehavior: none

  ImmutableAssetsCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Name: !Sub "ImmutableAssets-${Environment}"
        DefaultTTL: 31536000  # 1 year
        MaxTTL: 31536000      # 1 year
        MinTTL: 31536000      # 1 year
        ParametersInCacheKeyAndForwardedToOrigin:
          EnableAcceptEncodingGzip: true
          EnableAcceptEncodingBrotli: true
          QueryStringsConfig:
            QueryStringBehavior: none
          HeadersConfig:
            HeaderBehavior: none
          CookiesConfig:
            CookieBehavior: none

  VersionedAssetsCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Name: !Sub "VersionedAssets-${Environment}"
        DefaultTTL: 2592000   # 30 days
        MaxTTL: 31536000      # 1 year
        MinTTL: 0
        ParametersInCacheKeyAndForwardedToOrigin:
          EnableAcceptEncodingGzip: true
          EnableAcceptEncodingBrotli: true
          QueryStringsConfig:
            QueryStringBehavior: whitelist
            QueryStrings:
              - v
              - version
          HeadersConfig:
            HeaderBehavior: whitelist
            Headers:
              - Accept-Encoding
          CookiesConfig:
            CookieBehavior: none

  FontsCachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Name: !Sub "FontsCache-${Environment}"
        DefaultTTL: 31536000  # 1 year
        MaxTTL: 31536000      # 1 year
        MinTTL: 31536000      # 1 year
        ParametersInCacheKeyAndForwardedToOrigin:
          EnableAcceptEncodingGzip: false
          EnableAcceptEncodingBrotli: false
          QueryStringsConfig:
            QueryStringBehavior: none
          HeadersConfig:
            HeaderBehavior: whitelist
            Headers:
              - Origin
              - Access-Control-Request-Method
              - Access-Control-Request-Headers
          CookiesConfig:
            CookieBehavior: none

  APICachePolicy:
    Type: AWS::CloudFront::CachePolicy
    Properties:
      CachePolicyConfig:
        Name: !Sub "APICache-${Environment}"
        DefaultTTL: 300       # 5 minutes
        MaxTTL: 3600          # 1 hour
        MinTTL: 0
        ParametersInCacheKeyAndForwardedToOrigin:
          EnableAcceptEncodingGzip: true
          EnableAcceptEncodingBrotli: true
          QueryStringsConfig:
            QueryStringBehavior: all
          HeadersConfig:
            HeaderBehavior: whitelist
            Headers:
              - Authorization
              - Accept
              - Accept-Encoding
              - Accept-Language
              - User-Agent
          CookiesConfig:
            CookieBehavior: none

  # Origin Request Policies
  CORSOriginRequestPolicy:
    Type: AWS::CloudFront::OriginRequestPolicy
    Properties:
      OriginRequestPolicyConfig:
        Name: !Sub "CORSOriginRequest-${Environment}"
        QueryStringsConfig:
          QueryStringBehavior: all
        HeadersConfig:
          HeaderBehavior: whitelist
          Headers:
            - Origin
            - Access-Control-Request-Method
            - Access-Control-Request-Headers
            - Accept
            - Accept-Encoding
            - Accept-Language
        CookiesConfig:
          CookieBehavior: none

  # Response Headers Policy
  SecurityHeadersPolicy:
    Type: AWS::CloudFront::ResponseHeadersPolicy
    Properties:
      ResponseHeadersPolicyConfig:
        Name: !Sub "SecurityHeaders-${Environment}"
        SecurityHeadersConfig:
          StrictTransportSecurity:
            AccessControlMaxAgeSec: 31536000
            IncludeSubdomains: true
            Preload: true
          ContentTypeOptions:
            Override: true
          FrameOptions:
            FrameOption: DENY
            Override: true
          ReferrerPolicy:
            ReferrerPolicy: strict-origin-when-cross-origin
            Override: true
        CustomHeadersConfig:
          Items:
            - Header: X-Content-Type-Options
              Value: nosniff
              Override: true
            - Header: X-Frame-Options
              Value: DENY
              Override: true
            - Header: X-XSS-Protection
              Value: "1; mode=block"
              Override: true
            - Header: Permissions-Policy
              Value: "geolocation=(), microphone=(), camera=()"
              Override: true

  # S3 Bucket for Access Logs
  AccessLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${S3BucketName}-access-logs-${Environment}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldLogs
            Status: Enabled
            ExpirationInDays: 90

  # S3 Bucket Policy for CloudFront OAC
  StaticAssetsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref StaticAssetsBucket
      PolicyDocument:
        Statement:
          - Sid: AllowCloudFrontServicePrincipal
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub "${StaticAssetsBucket}/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${CloudFrontDistribution}"

  # Route 53 Record (if using custom domain)
  DNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt CloudFrontDistribution.DomainName
        HostedZoneId: Z2FDTNDATAQYW2  # CloudFront hosted zone ID

Parameters:
  HostedZoneId:
    Type: String
    Description: Route 53 hosted zone ID for the domain

Outputs:
  CloudFrontDistributionId:
    Description: CloudFront Distribution ID
    Value: !Ref CloudFrontDistribution
    Export:
      Name: !Sub "${AWS::StackName}-CloudFrontDistributionId"

  CloudFrontDomainName:
    Description: CloudFront Distribution Domain Name
    Value: !GetAtt CloudFrontDistribution.DomainName
    Export:
      Name: !Sub "${AWS::StackName}-CloudFrontDomainName"

  S3BucketName:
    Description: S3 Bucket Name for Static Assets
    Value: !Ref StaticAssetsBucket
    Export:
      Name: !Sub "${AWS::StackName}-S3BucketName"

  CDNUrl:
    Description: CDN URL for assets
    Value: !Sub "https://${DomainName}"
    Export:
      Name: !Sub "${AWS::StackName}-CDNUrl"